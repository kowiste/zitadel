version: '3.8'

services:
  # 1. The Database
  mvp-db:
    image: postgres:16-alpine
    container_name: mvp-db
    environment:
      POSTGRES_USER: zitadel
      POSTGRES_PASSWORD: zitadel_password
      POSTGRES_DB: zitadel
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zitadel -d zitadel"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - mvp-network
    volumes:
      - mvp_db_data:/var/lib/postgresql/data

  # 2. The Custom ZITADEL
  mvp-zitadel:
    container_name: mvp-zitadel
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile-zitadel-combined
    ports:
      - "8080:8080"
    networks:
      - mvp-network
    depends_on:
      mvp-db:
        condition: service_healthy
    volumes:
      # This volume is now mostly vestigial but kept for consistency
      - ./secrets:/zitadel-pat-key
    environment:
      ZITADEL_MASTERKEY: "MasterkeyNeedsToHave32Characters"
      ZITADEL_EXTERNALDOMAIN: localhost
      ZITADEL_TLS_ENABLED: false

      # DB Config
      ZITADEL_DATABASE_POSTGRES_HOST: mvp-db
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: zitadel_password
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: zitadel_password
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable

      # *** FIXED CLIENT CREDENTIALS SETUP ***
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_CLIENT_ID: go-client-id
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_CLIENT_SECRET: my-super-secure-secret-2025
      
      # Machine User Config
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_USERNAME: go-client-user
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_NAME: Go Provisioner
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_CLIENT_SECRET_EXPIRATIONDATE: '2030-01-01T00:00:00Z'

      # Default Human User 
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: admin
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: Password1!

networks:
  mvp-network:

volumes:
  mvp_db_data: